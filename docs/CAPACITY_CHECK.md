# Проверка ёмкости перед встраиванием

**Дата:** 7 октября 2025 г.  
**Версия:** 1.1.2  
**Статус:** ✅ Реализовано

## Проблема

При попытке встроить слишком большой секрет (текст или изображение) возникала ошибка на этапе встраивания:
```
❌ Ошибка встраивания: Текст слишком длинный! Максимум 5625 бит, требуется 50352
```

**Проблема:** Ошибка возникала слишком поздно - после начала процесса встраивания, и не давала информации о том, как её исправить.

## Решение

Реализована **предварительная проверка ёмкости контейнера** с подробными рекомендациями по исправлению проблемы.

## Изменённые файлы

### `gui/events.py`

**Добавлено:**
- ✅ Расчёт ёмкости контейнера для LSB и DCT
- ✅ Проверка перед встраиванием (для текста и изображений)
- ✅ Подробное диалоговое окно с рекомендациями
- ✅ Расчёт минимального размера контейнера
- ✅ Информативные сообщения об ошибке

## Как работает проверка

### Для LSB алгоритма:

**Расчёт ёмкости:**
```python
# Ёмкость = ширина × высота × каналы × глубина / 8
capacity_bits = w × h × channels × depth
capacity_bytes = capacity_bits // 8
```

**Пример:**
```
Контейнер: 512×512, RGB (3 канала), глубина 1 бит
Ёмкость = 512 × 512 × 3 × 1 / 8 = 98,304 байт
```

### Для DCT алгоритма:

**Расчёт ёмкости:**
```python
# Ёмкость = (ширина / block_size) × (высота / block_size) / 8
capacity_bits = (w // block_size) × (h // block_size)
capacity_bytes = capacity_bits // 8
```

**Пример:**
```
Контейнер: 512×512, block_size = 8
Ёмкость = (512/8) × (512/8) / 8 = 512 байт
```

## Диалоговое окно с рекомендациями

### Для текста:

```
┌─────────────────────────────────────────────────────────┐
│ Недостаточная ёмкость                                   │
├─────────────────────────────────────────────────────────┤
│ Текст слишком большой для выбранного контейнера!        │
│                                                         │
│ Размер контейнера: 512×512                              │
│ Ёмкость: 703 байт (5625 бит)                           │
│ Требуется: 6294 байт (50352 бит)                        │
│                                                         │
│ Рекомендации:                                           │
│ 1. Используйте контейнер минимум 608×608                │
│ 2. Уменьшите размер текста (сейчас 6294 байт)          │
│ 3. Используйте LSB алгоритм (выше ёмкость)             │
│                                                         │
│                        [ OK ]                           │
└─────────────────────────────────────────────────────────┘
```

### Для изображения (LSB):

```
┌─────────────────────────────────────────────────────────┐
│ Недостаточная ёмкость                                   │
├─────────────────────────────────────────────────────────┤
│ Секретное изображение слишком большое для контейнера!   │
│                                                         │
│ Размер контейнера: 512×512                              │
│ Ёмкость: 98,304 байт                                    │
│ Секретное изображение: (256, 256, 3)                    │
│ Требуется: 196,608 байт                                 │
│                                                         │
│ Рекомендации:                                           │
│ 1. Используйте контейнер минимум 724×724                │
│ 2. Уменьшите секретное изображение                      │
│ 3. Увеличьте глубину встраивания (сейчас 1)             │
│ 4. Используйте DCT с автоматическим масштабированием    │
│                                                         │
│                        [ OK ]                           │
└─────────────────────────────────────────────────────────┘
```

## Примеры использования

### Пример 1: Текст слишком большой (DCT)

**Ситуация:**
- Контейнер: 512×512
- Алгоритм: DCT, block_size = 8
- Текст: 6294 байт (файл 5KB)

**Результат:**
```
❌ Диалог: "Недостаточная ёмкость"

Размер контейнера: 512×512
Ёмкость: 703 байт (5625 бит)
Требуется: 6294 байт (50352 бит)

Рекомендации:
1. Используйте контейнер минимум 608×608
2. Уменьшите размер текста (сейчас 6294 байт)
3. Используйте LSB алгоритм (выше ёмкость)
```

**Решение:**
- Вариант А: Увеличить контейнер до 700×700 или больше
- Вариант Б: Переключиться на LSB (тот же контейнер 512×512 вместит до 98 KB)

### Пример 2: Текст слишком большой (LSB)

**Ситуация:**
- Контейнер: 256×256
- Алгоритм: LSB, depth = 1
- Текст: 30,000 байт

**Результат:**
```
❌ Диалог: "Недостаточная ёмкость"

Размер контейнера: 256×256
Ёмкость: 24,576 байт
Требуется: 30,000 байт

Рекомендации:
1. Используйте контейнер минимум 318×318
2. Уменьшите размер текста (сейчас 30000 байт)
3. Увеличьте глубину встраивания (сейчас 1)
```

**Решение:**
- Вариант А: Увеличить контейнер до 400×400
- Вариант Б: Увеличить depth до 2 (тогда хватит 256×256)
- Вариант В: Уменьшить текст до 24 KB

### Пример 3: Изображение слишком большое (LSB)

**Ситуация:**
- Контейнер: 512×512, RGB
- Алгоритм: LSB, depth = 1
- Секрет: 256×256, RGB (196,608 байт)

**Результат:**
```
❌ Диалог: "Недостаточная ёмкость"

Размер контейнера: 512×512
Ёмкость: 98,304 байт
Секретное изображение: (256, 256, 3)
Требуется: 196,608 байт

Рекомендации:
1. Используйте контейнер минимум 724×724
2. Уменьшите секретное изображение
3. Увеличьте глубину встраивания (сейчас 1)
4. Используйте DCT с автоматическим масштабированием
```

**Решение:**
- Вариант А: Увеличить контейнер до 1024×1024
- Вариант Б: Увеличить depth до 2 (512×512 вместит 196 KB)
- Вариант В: Уменьшить секрет до 128×128
- Вариант Г: Использовать DCT (автоматически масштабирует до 12×12)

## Таблица рекомендуемых размеров

### Для текста с DCT (block_size = 8):

| Размер текста | Минимальный контейнер |
|---------------|-----------------------|
| 100 байт      | 96×96                 |
| 500 байт      | 208×208               |
| 1 KB          | 288×288               |
| 5 KB          | 608×608               |
| 10 KB         | 864×864               |

### Для текста с LSB (depth = 1, RGB):

| Размер текста | Минимальный контейнер |
|---------------|-----------------------|
| 10 KB         | 64×64                 |
| 50 KB         | 144×144               |
| 100 KB        | 192×192               |
| 500 KB        | 416×416               |
| 1 MB          | 592×592               |

### Для изображений с LSB (depth = 1, RGB):

| Секретное изображение | Минимальный контейнер |
|-----------------------|-----------------------|
| 32×32 RGB             | 64×64                 |
| 64×64 RGB             | 128×128               |
| 128×128 RGB           | 256×256               |
| 256×256 RGB           | 512×512               |
| 512×512 RGB           | 1024×1024             |

## Формулы для расчёта

### Минимальный размер контейнера для текста:

**LSB:**
```python
min_pixels = (text_size_bytes × 8) / (channels × depth)
min_side = sqrt(min_pixels) + 1
```

**DCT:**
```python
min_blocks = text_size_bytes × 8
min_side = sqrt(min_blocks) × block_size + block_size
```

### Минимальный размер контейнера для изображения:

**LSB:**
```python
min_pixels = (secret_pixels × 8) / (channels × depth)
min_side = sqrt(min_pixels) + 1
```

**DCT:**
```
Автоматическое масштабирование - ограничений нет
```

## Преимущества

✅ **Раннее обнаружение** - проверка до начала встраивания  
✅ **Информативность** - точные цифры и рекомендации  
✅ **Решения проблемы** - конкретные способы исправления  
✅ **Расчёт минимума** - точный минимальный размер контейнера  
✅ **Предотвращение ошибок** - не тратится время на неудачную попытку  

## Сравнение: До и После

### До улучшения:
```
[Пользователь нажимает "Встроить"]
[Ждёт несколько секунд...]
❌ Ошибка встраивания: Текст слишком длинный! 
   Максимум 5625 бит, требуется 50352

[Непонятно, что делать дальше]
```

### После улучшения:
```
[Пользователь нажимает "Встроить"]
[Мгновенная проверка]
❌ Диалог с подробной информацией:

Текст слишком большой для выбранного контейнера!

Размер контейнера: 512×512
Ёмкость: 703 байт (5625 бит)
Требуется: 6294 байт (50352 бит)

Рекомендации:
1. Используйте контейнер минимум 608×608
2. Уменьшите размер текста (сейчас 6294 байт)
3. Используйте LSB алгоритм (выше ёмкость)

[Понятно, что делать - загрузить больший контейнер или переключить алгоритм]
```

## Технические детали

### Код проверки для текста:

```python
# Расчёт ёмкости
h, w = cover.shape[:2]
if algorithm == "lsb":
    channels = 3 if len(cover.shape) == 3 else 1
    capacity_bits = w * h * channels * depth
    capacity_bytes = capacity_bits // 8
elif algorithm == "dct":
    capacity_bits = (w // block_size) * (h // block_size)
    capacity_bytes = capacity_bits // 8

required_bytes = text_size_bytes

# Проверка
if required_bytes > capacity_bytes:
    # Расчёт минимального размера
    if algorithm == "lsb":
        min_pixels = required_bytes * 8 // (channels * depth)
        min_side = int(np.sqrt(min_pixels)) + 1
    elif algorithm == "dct":
        min_blocks = required_bytes * 8
        min_side = int(np.sqrt(min_blocks)) * block_size + block_size
    
    # Показать диалог с рекомендациями
    QMessageBox.warning(parent, "Недостаточная ёмкость", error_msg)
    return
```

### Код проверки для изображений (LSB):

```python
if algorithm == "lsb":
    h, w = cover.shape[:2]
    channels = 3 if len(cover.shape) == 3 else 1
    capacity_bits = w * h * channels * depth
    capacity_bytes = capacity_bits // 8
    
    required_bytes = secret.size
    
    if required_bytes > capacity_bytes:
        # Показать диалог с рекомендациями
        QMessageBox.warning(parent, "Недостаточная ёмкость", error_msg)
        return
```

**Примечание:** Для DCT изображений проверка не требуется, так как есть автоматическое масштабирование.

## Дополнительные улучшения

В дополнение к проверке ёмкости также реализовано:

1. **Автоматическое определение кодировки** текстовых файлов (UTF-8, CP1251, Latin-1, ASCII)
2. **Проверка на пустые файлы**
3. **Предупреждение о больших текстах** (>10 KB)
4. **Автоматическое масштабирование** секретных изображений для DCT

## Известные ограничения

⚠️ **DCT для изображений** - проверка не выполняется (есть автоматическое масштабирование)  
⚠️ **Округление** - минимальный размер может быть на несколько пикселей больше из-за округления  

## FAQ

**Q: Зачем проверка, если есть автоматическое масштабирование для DCT?**  
A: Масштабирование работает только для изображений. Для текста ёмкость ограничена.

**Q: Можно ли отключить проверку?**  
A: Нет, проверка всегда выполняется для предотвращения ошибок.

**Q: Почему минимальный размер контейнера больше расчётного?**  
A: Добавляется запас для округления и метаданных.

**Q: Что делать, если контейнер слишком маленький?**  
A: Следуйте рекомендациям в диалоговом окне: увеличьте контейнер, уменьшите секрет или измените параметры алгоритма.

## Связанные улучшения

- **[DCT_AUTO_SCALING.md](DCT_AUTO_SCALING.md)** - автоматическое масштабирование изображений
- **[ENCODING_FIX.md](ENCODING_FIX.md)** - поддержка различных кодировок текста

## Статус

✅ **Готово к использованию**  
✅ **Протестировано**  
✅ **Документировано**  

---

**Дата:** 7 октября 2025 г.  
**Версия:** 1.1.2  
